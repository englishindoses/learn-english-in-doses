<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Include standardized head content -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="{GRAMMAR_TOPIC} - Advanced ESL grammar explanation with examples and practice">
  <title>{GRAMMAR_TOPIC} - Advanced ESL Grammar</title>
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Open+Sans:wght@400;600&family=Source+Code+Pro&display=swap" rel="stylesheet">
  
  <!-- Favicon -->
  <link rel="apple-touch-icon" sizes="180x180" href="../../images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="../../images//favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../../images//favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  
  <!-- Styles - Note the updated path with "../../" -->
  <link rel="stylesheet" href="../../css/base.css">
  <link rel="stylesheet" href="../../css/activities.css">

  <!-- Page specific styles - including nav-indicator -->
  <style>
    /* Fix progress bar styling */
    .progress-container {
      margin-bottom: 30px;
      padding-bottom: 10px;
      clear: both;
    }
    
    .progress-container h4 {
      margin-top: 0;
      margin-bottom: 8px;
      font-size: 1rem;
    }
    
    /* Fix MCQ question display */
    #mcq .question {
      display: block !important;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border-color, #ddd);
    }
    
    .activity-container.active {
      display: block !important;
    }
    
    /* Ensure proper spacing between options */
    .options {
      margin-bottom: 15px;
    }
    
    /* Make sure feedback is visible */
    .feedback {
      margin-top: 10px;
      min-height: 20px;
    }
  </style>
</head>
<body>
  <!-- Include skip link and theme toggle -->
  <a href="#main-content" class="skip-link">Skip to content</a>
  
  <div class="theme-toggle-container">
    <button id="theme-toggle" class="theme-toggle" aria-label="Toggle dark mode">
      <span class="light-icon">‚òÄÔ∏è</span>
      <span class="dark-icon">üåô</span>
    </button>
  </div>
  
  <!-- Include navigation - Note the updated paths with "../../" -->
  <nav class="main-navigation">
    <a href="../../home.html" class="site-logo">
      <img src="../../images/my-logo.svg" alt="English in Doses" width="150" height="auto">
    </a>
    <button class="nav-toggle" aria-label="Toggle navigation">‚ò∞</button>
    <div class="nav-links">
      <a href="../../home.html" class="nav-link">Home</a>
      <a href="../../about.html" class="nav-link">About Us</a>
      <a href="../../contact.html" class="nav-link">Contact Us</a>
      <a href="../../home.html#where-to-start" class="nav-link">Grammar</a>
      <a href="../../extra-practice.html" class="nav-link">Extra Practice</a>
      <a href="../../conversation-page.html" class="nav-link">Conversation</a>
      <a href="../../my-progress.html" class="nav-link">My Progress</a>
    </div>

    <div class="advanced-nav-indicator"></div>
    
  </nav>

  <div class="container">
    <!-- Include breadcrumbs - Note the updated paths with "../" -->
    <div class="breadcrumbs" aria-label="breadcrumb">
      <span class="breadcrumb-item"><a href="../../home.html">Home</a></span>
      <span class="breadcrumb-separator">‚Ä∫</span>
      <span class="breadcrumb-item"><a href="advanced-grammar.html">Advanced Grammar</a></span>
      <span class="breadcrumb-separator">‚Ä∫</span>
      <span class="breadcrumb-item">{GRAMMAR_TOPIC}</span>
    </div>

    <main id="main-content">
      <h1>{GRAMMAR_TOPIC}</h1>

      <!-- Progress tracking display - ADDED -->
      <div class="progress-container">
        <h4>Your Progress</h4>
        <div id="activity-progress" data-progress-display data-progress-type="bar" 
             data-category="activities" data-item-id="{LESSON_ID}"></div>
      </div>

      <!-- INTRODUCTION SECTION -->
      <section class="intro-section">
        <h2>Introduction</h2>
        <p>{INTRODUCTION_TEXT}</p>
        
        <h3>After this lesson, you will be able to:</h3>
        <ul>
          <li>{LEARNING_OBJECTIVE_1}</li>
          <li>{LEARNING_OBJECTIVE_2}</li>
          <li>{LEARNING_OBJECTIVE_3}</li>
          <!-- 3 learning objectives only -->
        </ul>
      </section>

      <!-- GRAMMAR POINT SECTION 1 -->
      <section class="grammar-point">
        <h2>{GRAMMAR_CONCEPT_1}</h2>
        
        <p><strong>{MAIN_POINT_1}</strong>: {EXPLANATION_1}</p>
        
        <p><strong>Structure</strong>: {STRUCTURE_FORMULA_1}</p>
        
        <div class="example">
          <!-- examples from work, daily life and travel contexts -->
          <ol>
            <li>{EXAMPLE_1_1} (Simple explanation)</li>
            <li>{EXAMPLE_1_2} (Simple explanation)</li>
            <li>{EXAMPLE_1_3} (Simple explanation)</li>
          </ol>
        </div>
        
        <div class="note">
          <p><strong>Native speaker note:</strong> {NATIVE_SPEAKER_USAGE_1}</p>
        </div>
      </section>

      <!-- GRAMMAR POINT SECTION 2 -->
      <section class="grammar-point">
        <h2>{GRAMMAR_CONCEPT_2}</h2>
        
        <p><strong>{MAIN_POINT_2}</strong>: {EXPLANATION_2}</p>
        
        <p><strong>Structure</strong>: {STRUCTURE_FORMULA_2}</p>
        
        <div class="example">
          <!-- examples from work, daily life and travel contexts -->
          <ol>
            <li>{EXAMPLE_2_1} (Simple explanation)</li>
            <li>{EXAMPLE_2_2} (Simple explanation)</li>
            <li>{EXAMPLE_2_3} (Simple explanation)</li>
          </ol>
        </div>
        
        <div class="note">
          <p><strong>Native speaker note:</strong> {NATIVE_SPEAKER_USAGE_2}</p>
          <!-- include inline examples when necessary -->
        </div>
      </section>

      <!-- VISUAL COMPARISON TABLE -->
      <section id="summary"><!-- ADDED ID for linking -->
        <h2>Summary of {GRAMMAR_TOPIC}</h2>
        <table>
          <thead>
            <tr>
              <th>{COLUMN_1_HEADER}</th>
              <th>{COLUMN_2_HEADER}</th>
              <th>{COLUMN_3_HEADER}</th>
              <th>Example</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>{DATA_1_1}</td>
              <td>{DATA_1_2}</td>
              <td>{DATA_1_3}</td>
              <td><span class="example">{TABLE_EXAMPLE_1}</span></td>
            </tr>
            <tr>
              <td>{DATA_2_1}</td>
              <td>{DATA_2_2}</td>
              <td>{DATA_2_3}</td>
              <td><span class="example">{TABLE_EXAMPLE_2}</span></td>
            </tr>
            <!-- Add more rows as needed -->
          </tbody>
        </table>
      </section>

      <!-- COMMON ERRORS SECTION -->
      <section class="common-errors">
        <h2 class="common-errors-heading">Common Errors</h2>
        
        <div class="error-pattern">
          <p class="error-title"><strong>1: {ERROR_TITLE_1}</strong></p>
          <p class="incorrect">{INCORRECT_USAGE_1}</p>
          <p class="correct">{CORRECTED_VERSION_1} ‚úì</p>
          <p class="explanation"><em>{EXPLANATION_1}</em></p>
        </div>
        
        <div class="error-pattern">
          <p class="error-title"><strong>2: {ERROR_TITLE_2}</strong></p>
          <p class="incorrect">{INCORRECT_USAGE_2}</p>
          <p class="correct">{CORRECTED_VERSION_2} ‚úì</p>
          <p class="explanation"><em>{EXPLANATION_2}</em></p>
        </div>
        
        <div class="error-pattern">
          <p class="error-title"><strong>3: {ERROR_TITLE_3}</strong></p>
          <p class="incorrect">{INCORRECT_USAGE_3}</p>
          <p class="correct">{CORRECTED_VERSION_3} ‚úì</p>
          <p class="explanation"><em>{EXPLANATION_3}</em></p>
        </div>
      </section>

      <!-- TIPS SECTION -->
      <section class="tips">
        <h2 class="tips-heading">Useful Tips</h2>
        
        <div class="grammar-tip">
          <p>üìù <strong>TIP 1:</strong> {TIP_1}</p>
        </div>
        
        <div class="grammar-tip">
          <p>üìù <strong>TIP 2:</strong> {TIP_2}</p>
        </div>
        
        <div class="grammar-tip">
          <p>üìù <strong>TIP 3:</strong> {TIP_3}</p>
          <!-- Maximum 3 tips -->
        </div>
      </section>

      <!-- MCQ PRACTICE SECTION -->
      <section class="content-section mcq-container">
        <h2>Quick Practice</h2>
        <p>Test your understanding of {GRAMMAR_TOPIC} with these multiple choice questions.</p>
        
        <div id="mcq" class="activity-container active">
          <div class="question" id="q1">
            <p class="mcq-question">1. {MCQ_QUESTION_1}</p>
            <div class="options">
              <div class="option" data-index="0">
                <span>A. {OPTION_1_A}</span>
              </div>
              <div class="option" data-index="1">
                <span>B. {OPTION_1_B}</span>
              </div>
              <div class="option" data-index="2">
                <span>C. {OPTION_1_C}</span>
              </div>
              <div class="option" data-index="3">
                <span>D. {OPTION_1_D}</span>
              </div>
            </div>
            <div class="feedback"></div>
          </div>
          
          <div class="question" id="q2">
            <p class="mcq-question">2. {MCQ_QUESTION_2}</p>
            <div class="options">
              <div class="option" data-index="0">
                <span>A. {OPTION_2_A}</span>
              </div>
              <div class="option" data-index="1">
                <span>B. {OPTION_2_B}</span>
              </div>
              <div class="option" data-index="2">
                <span>C. {OPTION_2_C}</span>
              </div>
              <div class="option" data-index="3">
                <span>D. {OPTION_2_D}</span>
              </div>
            </div>
            <div class="feedback"></div>
          </div>
          
          <div class="question" id="q3">
            <p class="mcq-question">3. {MCQ_QUESTION_3}</p>
            <div class="options">
              <div class="option" data-index="0">
                <span>A. {OPTION_3_A}</span>
              </div>
              <div class="option" data-index="1">
                <span>B. {OPTION_3_B}</span>
              </div>
              <div class="option" data-index="2">
                <span>C. {OPTION_3_C}</span>
              </div>
              <div class="option" data-index="3">
                <span>D. {OPTION_3_D}</span>
              </div>
            </div>
            <div class="feedback"></div>
          </div>
          
          <div class="question" id="q4">
            <p class="mcq-question">4. {MCQ_QUESTION_4}</p>
            <div class="options">
              <div class="option" data-index="0">
                <span>A. {OPTION_4_A}</span>
              </div>
              <div class="option" data-index="1">
                <span>B. {OPTION_4_B}</span>
              </div>
              <div class="option" data-index="2">
                <span>C. {OPTION_4_C}</span>
              </div>
              <div class="option" data-index="3">
                <span>D. {OPTION_4_D}</span>
              </div>
            </div>
            <div class="feedback"></div>
          </div>
          
          <div class="question" id="q5">
            <p class="mcq-question">5. {MCQ_QUESTION_5}</p>
            <div class="options">
              <div class="option" data-index="0">
                <span>A. {OPTION_5_A}</span>
              </div>
              <div class="option" data-index="1">
                <span>B. {OPTION_5_B}</span>
              </div>
              <div class="option" data-index="2">
                <span>C. {OPTION_5_C}</span>
              </div>
              <div class="option" data-index="3">
                <span>D. {OPTION_5_D}</span>
              </div>
            </div>
            <div class="feedback"></div>
          </div>
          
          <div class="control-buttons">
            <button id="mcq-submit" class="submit-btn">Check Answers</button>
            <a href="#summary" class="nav-button">Review Grammar</a>
            <button id="mcq-restart" class="restart-btn" style="display:none;">Try Again</button>
            <button id="check-grammar" class="nav-button activities" style="display:none;">Check the Grammar</button><!-- ADDED -->
          </div>
          
          <div class="score-display" id="mcq-score" style="display:none;">
            Your score: <span>0</span>/5
          </div>
        </div>
      </section>
      
      <!-- Feedback Message Container - ADDED -->
      <div id="completion-feedback"></div>
    </main>
  </div>
  
  <!-- BOTTOM NAVIGATION -->
  <nav class="bottom-navigation">
    <a href="{PREVIOUS_TOPIC_URL}" class="nav-button previous">‚Üê Previous: {PREVIOUS_TOPIC}</a>
    <div class="center-buttons">
      <button class="nav-button print-button" onclick="window.print()">Print This Page</button>
      <a href="{PRACTICE_URL}" class="nav-button activities">Practice Activities</a>
    </div>
    <a href="{NEXT_TOPIC_URL}" class="nav-button next">Next: {NEXT_TOPIC} ‚Üí</a>
  </nav>

  <!-- Include footer - Note the updated paths with "../../" -->
  <footer>
    <div class="footer-content">
      <div class="footer-section">
        <h3>Quick Links</h3>
        <ul>
          <li><a href="../../home.html">Home</a></li>
          <li><a href="../../home.html#where-to-start">Grammar</a></li>
          <li><a href="../../extra-practice.html">Extra Practice</a></li>
          <li><a href="../../my-progress.html">My Progress</a></li>
        </ul>
      </div>
      
      <div class="footer-section">
        <h3>Grammar Topics</h3>
        <ul>
          <li><a href="advanced-grammar.html#advanced-tenses-and-aspect">Advanced Tenses</a></li>
          <li><a href="advanced-grammar.html#conditionals">Advanced Conditionals</a></li>
          <li><a href="advanced-grammar.html#modals">Advanced Modal Verbs</a></li>
          <li><a href="advanced-grammar.html#passive">Advanced Passive Voice</a></li>
        </ul>
      </div>
      
      <div class="footer-section">
        <h3>Connect</h3>
        <ul>
          <li><a href="../../about.html">About</a></li>
          <li><a href="../../contact.html">Contact</a></li>
          <!-- <li><a href="../../privacy.html">Privacy Policy</a></li> -->
        </ul>
      </div>
    </div>
    
    <div class="footer-bottom">
      <p>¬© 2025 English in Doses | All rights reserved | <a href="../../license.html">Licensing Information</a></p>
    </div>
  </footer>

  <!-- JavaScript - Updated with new progress tracking scripts -->
  <script src="../../js/core.js"></script>
  <script src="../../js/progress-tracking-module.js"></script>
  <script src="../../js/progress-manager-ui.js"></script>
  <script src="../../js/init-progress.js"></script>
  <script src="../../js/mcq.js"></script>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Make sure all questions are visible
      document.querySelectorAll('#mcq .question').forEach(function(question) {
        question.style.display = 'block';
      });
      
      // Initialize MCQ Module
      MCQModule.init({
        containerId: 'mcq',
        answers: {
          'q1': 2,  // Index of correct answer for question 1 (0-based)
          'q2': 1,  // Index of correct answer for question 2
          'q3': 0,  // Index of correct answer for question 3
          'q4': 3,  // Index of correct answer for question 4
          'q5': 2   // Index of correct answer for question 5
        },
        showAllQuestionsAtOnce: true, // ADDED
        // Add detailed explanations for feedback
        explanations: {
          'q1': '{EXPLANATION_Q1}',
          'q2': '{EXPLANATION_Q2}',
          'q3': '{EXPLANATION_Q3}',
          'q4': '{EXPLANATION_Q4}',
          'q5': '{EXPLANATION_Q5}'
        },
        showAllQuestionsAtOnce: true, // Show all questions at once
        onComplete: function(score, total) {
          console.log('MCQ completed with score: ' + score + '/' + total);
          
          // Track this activity completion in the progress system
          if (typeof ProgressTracker !== 'undefined' || typeof ProgressTrackingModule !== 'undefined') {
            const progressModule = typeof ProgressTracker !== 'undefined' ? 
              ProgressTracker : ProgressTrackingModule;
            
            // Mark the MCQ as completed in the 'activities' category
            progressModule.markItemCompleted('activities', 'mcq-{ACTIVITY_ID}', {
              score: score,
              maxScore: total,
              completed: true,
              completedAt: new Date().toISOString(),
              title: '{GRAMMAR_TOPIC} Quick Practice' // Human-readable title for activity listings
            });
            
            // Also mark the lesson itself as viewed/completed
            progressModule.updateItemProgress('lessons', '{LESSON_ID}', {
              lastViewed: new Date().toISOString(),
              progress: 100, // Percent complete
              title: '{GRAMMAR_TOPIC}' // Human-readable lesson title
            });
          }
          
          // Show feedback message - ADDED
          showCompletionFeedback(score, total);
        },
        grammarSummaryId: 'grammar-summary' // ADDED - for "Check the Grammar" button
      });
      
      // Setup the "Check the Grammar" button - ADDED
      const checkGrammarButton = document.getElementById('check-grammar');
      if (checkGrammarButton) {
        checkGrammarButton.addEventListener('click', function(e) {
          e.preventDefault();
          const summarySection = document.getElementById('grammar-summary');
          if (summarySection) {
            summarySection.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        });
      }
    });
    
    /**
     * Shows feedback to the user after completing the activity - ADDED
     * 
     * @param {number} score - The score achieved
     * @param {number} total - The total possible score
     */
    function showCompletionFeedback(score, total) {
      // Calculate percentage
      const percentage = Math.round((score / total) * 100);
      
      // Create feedback element if it doesn't exist
      let feedbackElement = document.getElementById('completion-feedback');
      
      if (!feedbackElement) {
        feedbackElement = document.createElement('div');
        feedbackElement.id = 'completion-feedback';
        feedbackElement.className = 'feedback-message';
        feedbackElement.style.marginTop = '20px';
        feedbackElement.style.padding = '15px';
        feedbackElement.style.borderRadius = '5px';
        feedbackElement.style.textAlign = 'center';
        
        // Add it after the MCQ container
        const mcqContainer = document.getElementById('mcq');
        if (mcqContainer && mcqContainer.parentNode) {
          mcqContainer.parentNode.insertBefore(feedbackElement, mcqContainer.nextSibling);
        }
      }
      
      // Set content and style based on score
      if (percentage >= 80) {
        feedbackElement.style.backgroundColor = 'var(--success-bg, #d4edda)';
        feedbackElement.style.color = 'var(--success-color, #155724)';
        feedbackElement.innerHTML = `
          <h3>Great job! üéâ</h3>
          <p>You scored ${score}/${total} (${percentage}%). Your progress has been saved.</p>
          <p>Why not try another activity to continue learning?</p>
        `;
      } else if (percentage >= 60) {
        feedbackElement.style.backgroundColor = 'var(--note-bg, #fff3cd)';
        feedbackElement.style.color = 'var(--note-color, #856404)';
        feedbackElement.innerHTML = `
          <h3>Good effort! üëç</h3>
          <p>You scored ${score}/${total} (${percentage}%). Your progress has been saved.</p>
          <p>Consider reviewing the grammar points above before moving on.</p>
        `;
      } else {
        feedbackElement.style.backgroundColor = 'var(--error-bg, #f8d7da)';
        feedbackElement.style.color = 'var(--error-color, #721c24)';
        feedbackElement.innerHTML = `
          <h3>Keep practicing üí™</h3>
          <p>You scored ${score}/${total} (${percentage}%). Your progress has been saved.</p>
          <p>Review the grammar section before trying again.</p>
        `;
      }
      
      // Scroll to feedback
      feedbackElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
  </script>
</body>
</html>