<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Learning Progress - English in Doses</title>
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Open+Sans:wght@400;600&family=Source+Code+Pro&display=swap" rel="stylesheet">
  
  <!-- Base styles and progress tracking styles -->
  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/progress-tracking.css">
  
  <style>
    /* Page-specific styles */
    .dashboard-container {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }
    
    @media (min-width: 992px) {
      .dashboard-container {
        grid-template-columns: 2fr 1fr;
      }
    }
    
    .dashboard-card {
      background-color: var(--card-bg, #fff);
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px var(--shadow-color, rgba(0, 0, 0, 0.1));
    }
    
    .dashboard-card h2 {
      margin-top: 0;
      margin-bottom: 15px;
      border-bottom: 1px solid var(--border-color, #ddd);
      padding-bottom: 10px;
      color: var(--heading-color, #222);
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background-color: var(--card-bg, #fff);
      padding: 15px;
      text-align: center;
      border-radius: 8px;
      box-shadow: 0 2px 4px var(--shadow-color, rgba(0, 0, 0, 0.1));
      transition: transform 0.3s;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 4px 8px var(--shadow-color, rgba(0, 0, 0, 0.15));
    }
    
    .stat-number {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--accent-color, #3498db);
      margin: 10px 0;
      font-family: 'Montserrat', sans-serif;
    }
    
    .stat-label {
      font-size: 0.9rem;
      color: var(--text-color, #333);
      opacity: 0.8;
    }
    
    .streak-card .stat-number {
      color: #f07d3e;
    }
    
    .danger-zone {
      margin-top: 50px;
      padding: 15px;
      background-color: var(--error-bg, #f8d7da);
      border: 1px solid var(--error-color, #dc3545);
      border-radius: 8px;
      color: var(--error-color, #721c24);
    }
    
    .btn {
      display: inline-block;
      padding: 10px 15px;
      border-radius: 4px;
      text-decoration: none;
      font-weight: 600;
      text-align: center;
      transition: all 0.3s ease;
      cursor: pointer;
      border: none;
    }
    
    .btn-primary {
      background-color: var(--accent-color, #3498db);
      color: white;
    }
    
    .btn-primary:hover {
      background-color: #2980b9;
    }
    
    .btn-secondary {
      background-color: #6c757d;
      color: white;
    }
    
    .btn-secondary:hover {
      background-color: #5a6268;
    }
    
    .btn-danger {
      background-color: var(--error-color, #dc3545);
      color: white;
    }
    
    .btn-danger:hover {
      background-color: #c82333;
    }
    
    /* Responsive Adjustments */
    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .stat-number {
        font-size: 2rem;
      }
    }
    
    @media (max-width: 480px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Skip link for accessibility -->
  <a href="#main-content" class="skip-link">Skip to content</a>
  
  <!-- Theme toggle button -->
  <div class="theme-toggle-container">
    <button id="theme-toggle" class="theme-toggle" aria-label="Toggle dark mode">
      <span class="light-icon">‚òÄÔ∏è</span>
      <span class="dark-icon">üåô</span>
    </button>
  </div>
  
  <!-- Main navigation -->
  <nav class="main-navigation">
    <a href="home.html" class="site-logo">
      <img src="images/my-logo.svg" alt="English in Doses" width="150" height="auto">
    </a>
    <button class="nav-toggle" aria-label="Toggle navigation">‚ò∞</button>
    <div class="nav-links">
      <a href="home.html" class="nav-link">Home</a>
      <a href="about.html" class="nav-link">About Us</a>
      <a href="contact.html" class="nav-link">Contact Us</a>
      <a href="home.html#where-to-start" class="nav-link">Grammar</a>
      <a href="extra-practice.html" class="nav-link">Extra Practice</a>
      <a href="conversation-page.html" class="nav-link">Conversation</a>
      <a href="my-progress.html" class="nav-link active" aria-current="page">My Progress</a>
    </div>
  </nav>

  <div class="container">
    <!-- Breadcrumbs -->
    <div class="breadcrumbs" aria-label="breadcrumb">
      <span class="breadcrumb-item"><a href="home.html">Home</a></span>
      <span class="breadcrumb-separator">‚Ä∫</span>
      <span class="breadcrumb-item">My Progress</span>
    </div>

    <main id="main-content">
      <h1>My Learning Progress</h1>
      
      <!-- No progress message (initially hidden) -->
      <div id="no-progress-message" class="no-progress-message" style="display: none;">
        <div class="no-progress-icon">üìä</div>
        <h2>No progress yet</h2>
        <p>You haven't completed any activities yet. Start learning to track your progress!</p>
        <a href="home.html#where-to-start" class="btn btn-primary">Start Learning</a>
      </div>
      
      <!-- Progress content -->
      <div id="progress-content">
        <!-- Summary Stats -->
        <section class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Overall Progress</div>
            <div id="overall-percentage" class="stat-number">0%</div>
            <div id="overall-fraction" class="stat-label">0/0 completed</div>
          </div>
          
          <div class="stat-card">
            <div class="stat-label">Activities Completed</div>
            <div id="activities-count" class="stat-number">0</div>
            <div class="stat-label">out of <span id="total-activities">0</span></div>
          </div>
          
          <div class="stat-card">
            <div class="stat-label">Lessons Completed</div>
            <div id="lessons-count" class="stat-number">0</div>
            <div class="stat-label">out of <span id="total-lessons">0</span></div>
          </div>
          
          <div class="stat-card streak-card">
            <div class="stat-label">Current Streak</div>
            <div id="streak-count" class="stat-number">0</div>
            <div class="stat-label">consecutive days</div>
          </div>
        </section>
        
        <!-- Dashboard Layout -->
        <div class="dashboard-container">
          <!-- Main Content Column -->
          <div class="dashboard-left">
            <!-- Progress Overview Card -->
            <div class="dashboard-card">
              <h2>Progress by Category</h2>
              <div id="category-progress"></div>
            </div>
            
            <!-- Recent Activity Card -->
            <div class="dashboard-card">
              <h2>Recent Activity</h2>
              <div id="recent-activity"></div>
            </div>
            
            <!-- Activity Grid Card -->
            <div class="dashboard-card">
              <h2>Grammar Activities</h2>
              <div id="activity-grid"></div>
            </div>
          </div>
          
          <!-- Sidebar Column -->
          <div class="dashboard-right">
            <!-- Achievements Card -->
            <div class="dashboard-card">
              <h2>Achievements</h2>
              <div id="achievements"></div>
            </div>
            
            <!-- Recommendations Card -->
            <div class="dashboard-card">
              <h2>Recommended Next Steps</h2>
              <div id="recommendations">
                <div class="recommendation-card">
                  <div class="recommendation-title">Continue learning Present Perfect Progressive</div>
                  <div class="recommendation-description">You've started this topic but haven't completed all activities yet.</div>
                  <a href="grammar/advanced/present-perfect-progressive.html" class="btn btn-primary">Continue</a>
                </div>
                
                <div class="recommendation-card">
                  <div class="recommendation-title">Try Past Perfect Progressive</div>
                  <div class="recommendation-description">This is a related topic that builds on what you've been learning.</div>
                  <a href="grammar/advanced/past-perfect-progressive.html" class="btn btn-primary">Start Learning</a>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Danger Zone -->
        <section class="danger-zone">
          <h2>Reset Progress</h2>
          <p>If you want to start fresh, you can delete and reset all your progress data. This action cannot be undone.</p>
          <button id="reset-progress" class="btn btn-danger">Reset All Progress</button>
        </section>
      </div>
    </main>
  </div>
  
  <!-- Footer -->
  <footer>
    <div class="footer-content">
      <div class="footer-section">
        <h3>Quick Links</h3>
        <ul>
          <li><a href="home.html">Home</a></li>
          <li><a href="home.html#where-to-start">Grammar</a></li>
          <li><a href="extra-practice.html">Extra Practice</a></li>
        </ul>
      </div>
      
      <div class="footer-section">
        <h3>Grammar Topics</h3>
        <ul>
          <li><a href="grammar/advanced/advanced-grammar.html#advanced-tenses-and-aspect">Advanced Tenses</a></li>
          <li><a href="grammar/advanced/advanced-grammar.html#conditionals">Advanced Conditionals</a></li>
          <li><a href="grammar/advanced/advanced-grammar.html#modals">Advanced Modal Verbs</a></li>
          <li><a href="grammar/advanced/advanced-grammar.html#passive">Advanced Passive Voice</a></li>
        </ul>
      </div>
      
      <div class="footer-section">
        <h3>Connect</h3>
        <ul>
          <li><a href="about.html">About</a></li>
          <li><a href="contact.html">Contact</a></li>
        </ul>
      </div>
    </div>
    
    <div class="footer-bottom">
      <p>¬© 2025 English in Doses | All rights reserved | <a href="license.html">Licensing Information</a></p>
    </div>
  </footer>

  <!-- JavaScript -->
  <script src="js/core.js"></script>
  <script src="js/progress-tracking.js"></script>
  <script src="js/progress-manager-ui.js"></script>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize Progress Tracking System
      ProgressTracker.init({
        categories: {
          activities: {
            grammarActivities: [
              'mcq-present-perfect-progressive', 'mcq-past-perfect-progressive',
              'mcq-future-perfect', 'mcq-modal-perfect',
              'gap-fill-present-perfect-progressive', 'gap-fill-past-perfect-progressive',
              'transformation-present-perfect-progressive', 'transformation-past-perfect-progressive',
              'matching-perfect-tenses', 'drag-drop-perfect-tenses',
              'mcq-present-perfect-vs-simple', 'mcq-past-perfect-vs-simple'
            ],
            practiceActivities: [
              'tenses-practice', 'conditionals-practice', 'modals-practice',
              'passive-practice', 'articles-practice', 'prepositions-practice'
            ]
          },
          lessons: {
            grammarLessons: [
              'present-perfect-progressive', 'past-perfect-progressive',
              'future-perfect', 'modal-perfect-forms',
              'present-perfect-vs-simple', 'past-perfect-vs-simple',
              'conditionals', 'inverted-conditionals',
              'wish-if-only', 'modal-passive'
            ],
            specialTopics: [
              'academic-writing', 'business-english', 'pronunciation'
            ]
          },
          assessments: {
            grammarTests: [
              'tenses-test', 'conditionals-test', 'modals-test',
              'passive-test', 'articles-test', 'prepositions-test'
            ],
            comprehensiveTests: [
              'mid-course-test', 'final-test'
            ]
          }
        },
        onProgressChange: function(details) {
          console.log('Progress changed:', details);
          updateStatCards();
        }
      });
      
      // Initialize UI Components
      ProgressManagerUI.init({
        progressDataProvider: ProgressTracker.getOverallProgress,
        categoryDefinitions: ProgressTracker.getCategoryDefinitions(),
        animateProgressBars: true
      });
      
      // Create UI components
      ProgressManagerUI.createProgressSummary('category-progress');
      ProgressManagerUI.createAchievementDisplay('achievements', { showAll: true });
      ProgressManagerUI.createActivityGrid('activity-grid', { category: 'activities' });
      
      // Create recent activity display
      createRecentActivityDisplay();
      
      // Set up progress reset button
      document.getElementById('reset-progress').addEventListener('click', function() {
        if (confirm('Are you sure you want to reset all progress? This action cannot be undone.')) {
          ProgressTracker.resetAllProgress(false);
          location.reload();
        }
      });
      
      // Check for initial progress and update UI
      checkInitialProgress();
      
      // Update stat cards
      updateStatCards();
    });
    
    /**
     * Checks if there's any progress and shows/hides appropriate UI
     */
    function checkInitialProgress() {
      try {
        // Get progress data
        const progress = ProgressTracker.getOverallProgress();
        
        // Check if we have any completed items
        const hasProgress = 
          (progress.completed > 0) || 
          (ProgressTracker.getStats().dailyStreak > 0);
        
        // Show appropriate content
        document.getElementById('no-progress-message').style.display = hasProgress ? 'none' : 'block';
        document.getElementById('progress-content').style.display = hasProgress ? 'block' : 'none';
      } catch (error) {
        console.error('Error checking initial progress:', error);
        // Show both just in case
        document.getElementById('no-progress-message').style.display = 'block';
        document.getElementById('progress-content').style.display = 'none';
      }
    }
    
    /**
     * Updates the stat card values
     */
    function updateStatCards() {
      try {
        // Get progress data
        const progress = ProgressTracker.getOverallProgress();
        const stats = ProgressTracker.getStats();
        
        // Update overall percentage
        document.getElementById('overall-percentage').textContent = progress.percentage + '%';
        document.getElementById('overall-fraction').textContent = 
          progress.completed + '/' + progress.total + ' completed';
        
        // Update activities count
        document.getElementById('activities-count').textContent = 
          progress.categories.activities ? progress.categories.activities.completed : 0;
        document.getElementById('total-activities').textContent = 
          progress.categories.activities ? progress.categories.activities.total : 0;
        
        // Update lessons count
        document.getElementById('lessons-count').textContent = 
          progress.categories.lessons ? progress.categories.lessons.completed : 0;
        document.getElementById('total-lessons').textContent = 
          progress.categories.lessons ? progress.categories.lessons.total : 0;
        
        // Update streak count
        document.getElementById('streak-count').textContent = stats.dailyStreak || 0;
      } catch (error) {
        console.error('Error updating stat cards:', error);
      }
    }
    
    /**
     * Creates a recent activity display
     */
    function createRecentActivityDisplay() {
      try {
        const container = document.getElementById('recent-activity');
        if (!container) return;
        
        // Get recent activities
        const activities = getRecentActivities(5);
        
        if (activities.length === 0) {
          container.innerHTML = '<p>No recent activity to display. Start learning to see your activity here!</p>';
          return;
        }
        
        // Create activity list
        const activityList = document.createElement('ul');
        activityList.className = 'activity-list';
        activityList.style.listStyle = 'none';
        activityList.style.padding = '0';
        activityList.style.margin = '0';
        
        activities.forEach(activity => {
          const item = document.createElement('li');
          item.className = 'activity-item';
          item.style.display = 'flex';
          item.style.alignItems = 'center';
          item.style.padding = '12px';
          item.style.borderRadius = '8px';
          item.style.marginBottom = '10px';
          item.style.backgroundColor = 'var(--card-bg, #fff)';
          item.style.boxShadow = '0 1px 3px var(--shadow-color, rgba(0, 0, 0, 0.1))';
          
          // Determine icon based on activity type
          let icon = 'üìù';
          if (activity.category === 'lessons') {
            icon = 'üìö';
          } else if (activity.category === 'assessments') {
            icon = 'üìä';
          }
          
          const iconEl = document.createElement('span');
          iconEl.className = 'activity-icon';
          iconEl.textContent = icon;
          iconEl.style.fontSize = '1.5rem';
          iconEl.style.marginRight = '15px';
          iconEl.style.width = '30px';
          iconEl.style.textAlign = 'center';
          item.appendChild(iconEl);
          
          const details = document.createElement('div');
          details.className = 'activity-details';
          details.style.flexGrow = '1';
          
          const title = document.createElement('span');
          title.className = 'activity-title';
          title.textContent = activity.title;
          title.style.display = 'block';
          title.style.fontWeight = '600';
          title.style.marginBottom = '5px';
          details.appendChild(title);
          
          const meta = document.createElement('div');
          meta.className = 'activity-meta';
          meta.style.display = 'flex';
          meta.style.fontSize = '0.8rem';
          meta.style.color = 'var(--secondary-text, #666)';
          
          if (activity.score !== undefined && activity.maxScore !== undefined) {
            const score = document.createElement('span');
            score.className = 'activity-score';
            score.textContent = `Score: ${activity.score}/${activity.maxScore}`;
            score.style.marginRight = '15px';
            meta.appendChild(score);
          }
          
          const date = document.createElement('span');
          date.className = 'activity-date';
          date.textContent = formatRelativeTime(activity.completedAt || activity.timestamp);
          meta.appendChild(date);
          
          details.appendChild(meta);
          item.appendChild(details);
          
          activityList.appendChild(item);
        });
        
        container.appendChild(activityList);
      } catch (error) {
        console.error('Error creating recent activity display:', error);
        container.innerHTML = '<p>Error loading recent activity.</p>';
      }
    }
    
    /**
     * Gets recent activities from progress data
     * 
     * @param {number} limit - Maximum number of activities to return
     * @returns {Array} - Array of recent activities
     */
    function getRecentActivities(limit = 5) {
      try {
        const progressData = ProgressTracker.getProgressData();
        if (!progressData) return [];
        
        const activities = [];
        
        // Get activities
        if (progressData.activities) {
          Object.entries(progressData.activities).forEach(([id, data]) => {
            if (data.completed) {
              activities.push({
                id: id,
                category: 'activities',
                title: data.title || formatId(id),
                score: data.score,
                maxScore: data.maxScore,
                completedAt: data.completedAt,
                timestamp: data.completedAt || new Date().toISOString()
              });
            }
          });
        }
        
        // Get lessons
        if (progressData.lessons) {
          Object.entries(progressData.lessons).forEach(([id, data]) => {
            if (data.lastViewed) {
              activities.push({
                id: id,
                category: 'lessons',
                title: data.title || formatId(id),
                timestamp: data.lastViewed || new Date().toISOString()
              });
            }
          });
        }
        
        // Get assessments
        if (progressData.assessments) {
          Object.entries(progressData.assessments).forEach(([id, data]) => {
            if (data.completed) {
              activities.push({
                id: id,
                category: 'assessments',
                title: data.title || formatId(id),
                score: data.score,
                maxScore: data.maxScore,
                completedAt: data.completedAt,
                timestamp: data.completedAt || new Date().toISOString()
              });
            }
          });
        }
        
        // Sort by timestamp (newest first)
        activities.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        
        // Return limited number
        return activities.slice(0, limit);
      } catch (error) {
        console.error('Error getting recent activities:', error);
        return [];
      }
    }
    
    /**
     * Formats an ID into a readable title
     * 
     * @param {string} id - The ID to format
     * @returns {string} - Formatted title
     */
    function formatId(id) {
      return id
        .replace(/^mcq-/, '')
        .replace(/^gap-fill-/, '')
        .replace(/^transformation-/, '')
        .replace(/-/g, ' ')
        .replace(/([A-Z])/g, ' $1')
        .replace(/\b\w/g, l => l.toUpperCase());
    }
    
    /**
     * Formats a timestamp into a relative time string
     * 
     * @param {string} timestamp - ISO timestamp
     * @returns {string} - Relative time string
     */
    function formatRelativeTime(timestamp) {
      if (!timestamp) return 'Unknown time';
      
      const date = new Date(timestamp);
      if (isNaN(date.getTime())) return 'Invalid date';
      
      const now = new Date();
      const diffInSeconds = Math.floor((now - date) / 1000);
      
      if (diffInSeconds < 60) {
        return 'Just now';
      }
      
      const diffInMinutes = Math.floor(diffInSeconds / 60);
      if (diffInMinutes < 60) {
        return `${diffInMinutes} minute${diffInMinutes !== 1 ? 's' : ''} ago`;
      }
      
      const diffInHours = Math.floor(diffInMinutes / 60);
      if (diffInHours < 24) {
        return `${diffInHours} hour${diffInHours !== 1 ? 's' : ''} ago`;
      }
      
      const diffInDays = Math.floor(diffInHours / 24);
      if (diffInDays < 7) {
        return diffInDays === 0 ? 'Today' : 
               diffInDays === 1 ? 'Yesterday' : 
               `${diffInDays} days ago`;
      }
      
      const options = { month: 'short', day: 'numeric' };
      return date.toLocaleDateString(undefined, options);
    }
  </script>
  
  <!-- Debug Tools (only in development) -->
  <script src="js/progress-tracking-debug.js"></script>
</body>
</html>
